import nodemailer from 'nodemailer';
import QRCode from 'qrcode';
import type { ReceiptData } from '../repositories/receiptRepo';
import logger from '../lib/logger';

const log = logger.child({ module: 'email' });

export interface VerificationEmailParams {
  to: string;
  token: string;
  expiresAt: Date;
  email: string; // explicit duplicate
}

export interface ReceiptEmailParams {
  to: string;
  receipt: ReceiptData;
}

export interface BookingConfirmationParams {
  to: string;
  customerName: string;
  bookingId: string;
  roomName: string;
  date: string; // YYYY-MM-DD
  startTime: Date;
  endTime: Date;
  hours: number;
  price: string;
  customerTimezone?: string; // Customer's timezone (e.g., 'America/Halifax')
}

export interface ContactEmailParams {
  firstName: string;
  lastName: string;
  email: string;
  message: string;
}

let cachedTransport: nodemailer.Transporter | null = null;

function getTransport() {
  if (cachedTransport) return cachedTransport;
  const user = process.env.GMAIL_USER;
  const pass = process.env.GMAIL_APP_PASSWORD;
  if (!user || !pass) {
    log.warn('Missing GMAIL_USER/GMAIL_APP_PASSWORD; logging emails only.');
    return null;
  }
  cachedTransport = nodemailer.createTransport({ service: 'gmail', auth: { user, pass } });
  return cachedTransport;
}

export async function sendVerificationEmail({ to, token, expiresAt, email }: VerificationEmailParams) {
  // Always point verification links to the FRONTEND app
  const origin = process.env.FRONTEND_ORIGIN || 'http://localhost:5173';
  // Frontend page will handle POST /api/auth/verify
  const link = `${origin.replace(/\/$/, '')}/verify?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`;
  const subject = 'Your K one Golf sign-in link';
  const text = `Sign in: ${link}\n\nExpires: ${expiresAt.toISOString()}\nIf you did not request this, ignore.`;
  const html = `<!doctype html><html><body style="font-family:system-ui,sans-serif"><h2>K one Golf Sign-In</h2><p>Click the button below to sign in. Expires in 15 minutes.</p><p><a href="${link}" style="display:inline-block;padding:10px 16px;background:#2563eb;color:#fff;text-decoration:none;border-radius:6px">Verify & Sign In</a></p><p style="font-size:12px;color:#555">If the button doesn't work, use this URL:<br>${link}</p></body></html>`;
  const transport = getTransport();
  if (!transport) {
    log.info({ to, link }, 'Dev-log: verification email (no transport)');
    return;
  }
  await transport.sendMail({ from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>', to, subject, text, html });
}

export interface PasswordResetEmailParams {
  to: string;
  email: string;
  token: string;
  expiresAt: Date;
}

export async function sendPasswordResetEmail({ to, email, token, expiresAt }: PasswordResetEmailParams) {
  const origin = process.env.FRONTEND_ORIGIN || 'http://localhost:5173';
  const link = `${origin.replace(/\/$/, '')}/reset-password?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`;
  const subject = 'Reset your K one Golf password';
  const text = `Reset your password: ${link}\n\nExpires: ${expiresAt.toISOString()}\nIf you did not request this, ignore this email.`;
  const html = `<!doctype html><html><body style="font-family:system-ui,sans-serif;background:#f8fafc;padding:20px"><div style="max-width:480px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1)"><div style="background:linear-gradient(135deg,#f59e0b 0%,#eab308 100%);padding:24px;text-align:center"><h1 style="margin:0;color:#fff;font-size:24px;font-weight:700">K ONE GOLF</h1><p style="margin:4px 0 0;color:rgba(255,255,255,0.9);font-size:13px">Password Reset</p></div><div style="padding:32px 24px"><p style="color:#334155;font-size:15px;line-height:1.6;margin:0 0 20px">We received a request to reset your password. Click the button below to create a new password. This link expires in 15 minutes.</p><p style="text-align:center;margin:24px 0"><a href="${link}" style="display:inline-block;padding:12px 32px;background:#2563eb;color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:15px">Reset Password</a></p><p style="font-size:12px;color:#64748b;margin:20px 0 0;line-height:1.5">If the button doesn't work, copy and paste this URL into your browser:<br><a href="${link}" style="color:#2563eb;word-break:break-all">${link}</a></p><p style="font-size:12px;color:#94a3b8;margin:16px 0 0">If you didn't request a password reset, you can safely ignore this email.</p></div></div></body></html>`;
  const transport = getTransport();
  if (!transport) {
    log.info({ to, link }, 'Dev-log: password reset email (no transport)');
    return;
  }
  await transport.sendMail({ from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>', to, subject, text, html });
}

/**
 * Generate HTML for receipt email
 */
function generateReceiptHTML(receipt: ReceiptData): string {
  const seatRows = receipt.items.seats
    .map(
      (seat) => {
        const hasDiscounts = seat.discounts && seat.discounts.length > 0;
        return `
        <tr>
          <td colspan="3" style="padding: 12px 0 4px 0; font-weight: 600; color: #334155; border-top: 1px solid #e2e8f0;">
            Seat ${seat.seatIndex}
          </td>
        </tr>
        ${seat.orders
          .map(
            (order) => `
          <tr>
            <td style="padding: 4px 8px; color: #475569;">${order.name}</td>
            <td style="padding: 4px 8px; text-align: center; color: #475569;">√ó${order.quantity}</td>
            <td style="padding: 4px 8px; text-align: right; color: #475569;">$${order.total.toFixed(2)}</td>
          </tr>
        `
          )
          .join('')}
        ${hasDiscounts ? `
          <tr>
            <td colspan="2" style="padding: 4px 8px; color: #64748b; font-size: 12px; border-top: 1px dashed #e2e8f0;">Subtotal</td>
            <td style="padding: 4px 8px; text-align: right; color: #64748b; font-size: 12px; border-top: 1px dashed #e2e8f0;">$${seat.preDiscountSubtotal.toFixed(2)}</td>
          </tr>
          ${seat.discounts
            .map(
              (d) => `
            <tr>
              <td colspan="2" style="padding: 2px 8px; color: #059669; font-size: 12px;">‚Ü≥ ${d.name}</td>
              <td style="padding: 2px 8px; text-align: right; color: #059669; font-size: 12px;">-$${Math.abs(d.total).toFixed(2)}</td>
            </tr>
          `
            )
            .join('')}
        ` : ''}
      `;
      }
    )
    .join('');

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>K one Golf Receipt</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); padding: 32px 24px; text-align: center; border-radius: 12px 12px 0 0;">
      <h1 style="margin: 0; color: white; font-size: 28px; font-weight: 700;">K ONE GOLF</h1>
      <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">Premium Screen Golf</p>
    </div>
    
    <!-- Receipt Content -->
    <div style="background: white; padding: 32px 24px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <!-- Receipt Number -->
      <div style="text-align: center; padding-bottom: 24px; border-bottom: 2px solid #f1f5f9;">
        <p style="margin: 0; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Receipt</p>
        <p style="margin: 4px 0 0 0; color: #0f172a; font-size: 20px; font-weight: 600;">${receipt.receiptNumber}</p>
      </div>
      
      <!-- Customer Info -->
      <div style="padding: 20px 0; border-bottom: 1px solid #f1f5f9;">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 4px 0; color: #64748b; font-size: 13px;">Customer:</td>
            <td style="padding: 4px 0; color: #0f172a; font-size: 13px; text-align: right; font-weight: 500;">${receipt.customer.name}</td>
          </tr>
          <tr>
            <td style="padding: 4px 0; color: #64748b; font-size: 13px;">Phone:</td>
            <td style="padding: 4px 0; color: #0f172a; font-size: 13px; text-align: right; font-weight: 500;">${receipt.customer.phone}</td>
          </tr>
          <tr>
            <td style="padding: 4px 0; color: #64748b; font-size: 13px;">Date:</td>
            <td style="padding: 4px 0; color: #0f172a; font-size: 13px; text-align: right; font-weight: 500;">${receipt.booking.date}</td>
          </tr>
          <tr>
            <td style="padding: 4px 0; color: #64748b; font-size: 13px;">Time:</td>
            <td style="padding: 4px 0; color: #0f172a; font-size: 13px; text-align: right; font-weight: 500;">${receipt.booking.startTime} - ${receipt.booking.endTime}</td>
          </tr>
        </table>
      </div>
      
      <!-- Items -->
      <div style="padding: 20px 0;">
        <h3 style="margin: 0 0 12px 0; color: #0f172a; font-size: 16px; font-weight: 600;">Items</h3>
        <table style="width: 100%; border-collapse: collapse;">
          ${receipt.items.roomCharge.total > 0 ? `
          <tr>
            <td style="padding: 8px 0; color: #475569; font-weight: 500;">${receipt.items.roomCharge.description}</td>
            <td style="padding: 8px 0; text-align: center; color: #475569;">√ó${receipt.items.roomCharge.quantity}</td>
            <td style="padding: 8px 0; text-align: right; color: #0f172a; font-weight: 600;">$${receipt.items.roomCharge.total.toFixed(2)}</td>
          </tr>
          ` : ''}
          ${seatRows}
        </table>
      </div>
      
      <!-- Totals -->
      <div style="padding: 20px 0; border-top: 2px solid #f1f5f9;">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="padding: 6px 0; color: #64748b; font-size: 14px;">Subtotal:</td>
            <td style="padding: 6px 0; text-align: right; color: #0f172a; font-size: 14px; font-weight: 500;">$${receipt.totals.subtotal}</td>
          </tr>
          <tr>
            <td style="padding: 6px 0; color: #64748b; font-size: 14px;">Tax (${receipt.totals.taxRate}%):</td>
            <td style="padding: 6px 0; text-align: right; color: #0f172a; font-size: 14px; font-weight: 500;">$${receipt.totals.tax}</td>
          </tr>
          ${parseFloat(receipt.totals.tip) > 0 ? `
          <tr>
            <td style="padding: 6px 0; color: #64748b; font-size: 14px;">Tip:</td>
            <td style="padding: 6px 0; text-align: right; color: #0f172a; font-size: 14px; font-weight: 500;">$${receipt.totals.tip}</td>
          </tr>
          ` : ''}
          <tr style="border-top: 2px solid #0f172a;">
            <td style="padding: 12px 0 0 0; color: #0f172a; font-size: 18px; font-weight: 700;">Total:</td>
            <td style="padding: 12px 0 0 0; text-align: right; color: #f59e0b; font-size: 18px; font-weight: 700;">$${receipt.totals.grandTotal}</td>
          </tr>
        </table>
      </div>
      
      <!-- Payment Status -->
      <div style="padding: 16px; background: ${receipt.payment.status === 'PAID' ? '#dcfce7' : '#fef3c7'}; border-radius: 8px; text-align: center; margin-top: 20px;">
        <p style="margin: 0; color: ${receipt.payment.status === 'PAID' ? '#15803d' : '#a16207'}; font-size: 14px; font-weight: 600;">
          ${receipt.payment.status === 'PAID' ? '‚úì PAID' : receipt.payment.status === 'PARTIAL' ? '‚óê PARTIALLY PAID' : '‚óã UNPAID'}
        </p>
        ${receipt.payment.method ? `<p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">Payment Method: ${receipt.payment.method}</p>` : ''}
      </div>
      
      <!-- Sign-Up CTA -->
      <div style="margin-top: 24px; padding: 24px; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); border-radius: 12px; text-align: center;">
        <p style="margin: 0 0 8px 0; color: white; font-size: 18px; font-weight: 700;">üì± Book Faster Next Time!</p>
        <p style="margin: 0 0 16px 0; color: rgba(255,255,255,0.95); font-size: 14px;">Create a free account to view your booking history and enjoy a streamlined booking experience.</p>
        <a href="${process.env.FRONTEND_ORIGIN || 'http://localhost:5173'}/signup" style="display: inline-block; padding: 12px 32px; background: white; color: #f59e0b; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">Create Free Account</a>
      </div>
      
      <!-- Footer -->
      <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #f1f5f9; text-align: center;">
        <p style="margin: 0; color: #0f172a; font-size: 14px; font-weight: 600;">${receipt.business.name}</p>
        <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">${receipt.business.address}</p>
        <p style="margin: 4px 0 0 0; color: #64748b; font-size: 12px;">${receipt.business.phone}</p>
        <p style="margin: 16px 0 0 0; color: #94a3b8; font-size: 11px;">Thank you for choosing K one Golf!</p>
      </div>
    </div>
  </div>
</body>
</html>
  `;
}

/**
 * Send receipt to customer via email
 */
export async function sendReceiptEmail({ to, receipt }: ReceiptEmailParams) {
  const subject = `K one Golf Receipt - ${receipt.receiptNumber}`;
  const html = generateReceiptHTML(receipt);
  const text = `
K one Golf Receipt
${receipt.receiptNumber}

Customer: ${receipt.customer.name}
Date: ${receipt.booking.date}
Time: ${receipt.booking.startTime} - ${receipt.booking.endTime}

${receipt.items.roomCharge.total > 0 ? `Room Charge: $${receipt.items.roomCharge.total.toFixed(2)}\n` : ''}
${receipt.items.seats.map((seat) => `
Seat ${seat.seatIndex}:
${seat.orders.map((order) => `  ${order.name} √ó${order.quantity} - $${order.total.toFixed(2)}`).join('\n')}
`).join('\n')}

Subtotal: $${receipt.totals.subtotal}
Tax (${receipt.totals.taxRate}%): $${receipt.totals.tax}
${parseFloat(receipt.totals.tip) > 0 ? `Tip: $${receipt.totals.tip}\n` : ''}
Total: $${receipt.totals.grandTotal}

Payment Status: ${receipt.payment.status}
${receipt.payment.method ? `Payment Method: ${receipt.payment.method}` : ''}

Thank you for choosing K-Golf!
${receipt.business.name}
${receipt.business.address}
${receipt.business.phone}
  `.trim();

  const transport = getTransport();
  if (!transport) {
    log.info({ to, receiptNumber: receipt.receiptNumber }, 'Dev-log: receipt email (no transport)');
    return;
  }

  await transport.sendMail({
    from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>',
    to,
    subject,
    text,
    html,
  });
}

/**
 * Generate ICS calendar file content
 */
function generateICS(params: BookingConfirmationParams): string {
  const { customerName, bookingId, roomName, startTime, endTime, hours, price } = params;
  
  // Format dates for ICS (YYYYMMDDTHHMMSSZ)
  const formatICSDate = (date: Date): string => {
    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  };

  const now = new Date();
  const dtstamp = formatICSDate(now);
  const dtstart = formatICSDate(startTime);
  const dtend = formatICSDate(endTime);
  
  // Generate UID
  const uid = `booking-${bookingId}@konegolf.ca`;
  
  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//K one Golf//Booking System//EN',
    'CALSCALE:GREGORIAN',
    'METHOD:REQUEST',
    'BEGIN:VEVENT',
    `UID:${uid}`,
    `DTSTAMP:${dtstamp}`,
    `DTSTART:${dtstart}`,
    `DTEND:${dtend}`,
    `SUMMARY:K one Golf - ${roomName}`,
    `DESCRIPTION:Your screen golf booking at K one Golf\\n\\nRoom: ${roomName}\\nDuration: ${hours} hour${hours > 1 ? 's' : ''}\\nPrice: $${price}\\n\\nBooking ID: ${bookingId}\\n\\nAddress: 45 Keltic Dr\\, Unit 6\\, Sydney\\, NS\\nPhone: (902) 270-2259`,
    'LOCATION:K one Golf\\, 45 Keltic Dr\\, Unit 6\\, Sydney\\, NS',
    `ORGANIZER;CN=K one Golf:mailto:${process.env.EMAIL_FROM || 'no-reply@konegolf.ca'}`,
    `ATTENDEE;CN=${customerName};RSVP=TRUE:mailto:${params.to}`,
    'STATUS:CONFIRMED',
    'SEQUENCE:0',
    'BEGIN:VALARM',
    'TRIGGER:-PT1H',
    'ACTION:DISPLAY',
    'DESCRIPTION:K one Golf booking in 1 hour',
    'END:VALARM',
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
  
  return icsContent;
}

/**
 * Generate HTML for booking confirmation email
 */
function generateBookingConfirmationHTML(params: BookingConfirmationParams): string {
  const { customerName, roomName, date, startTime, endTime, hours, price, customerTimezone } = params;
  
  // Use customer's timezone or default to Halifax
  const tz = customerTimezone || 'America/Halifax';
  
  const formatTime = (d: Date) => d.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true,
    timeZone: tz
  });
  
  const formatDate = (dateStr: string) => {
    // Parse date string as UTC to avoid timezone shifts
    const [y, m, d] = dateStr.split('-');
    const date = new Date(Date.UTC(parseInt(y), parseInt(m) - 1, parseInt(d), 12, 0, 0));
    return date.toLocaleDateString('en-US', { 
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      timeZone: tz
    });
  };

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Confirmation - K one Golf</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); padding: 32px 24px; text-align: center; border-radius: 12px 12px 0 0;">
      <h1 style="margin: 0; color: white; font-size: 28px; font-weight: 700;">K ONE GOLF</h1>
      <p style="margin: 8px 0 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">Premium Screen Golf</p>
    </div>
    
    <!-- Confirmation Content -->
    <div style="background: white; padding: 32px 24px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <!-- Success Message -->
      <div style="text-align: center; padding-bottom: 24px; border-bottom: 2px solid #f1f5f9;">
        <table style="width: 64px; height: 64px; margin: 0 auto 16px; background: #dcfce7; border-radius: 50%;">
          <tr>
            <td style="text-align: center; vertical-align: middle;">
              <span style="font-size: 32px; line-height: 1; color: #15803d;">‚úì</span>
            </td>
          </tr>
        </table>
        <h2 style="margin: 0; color: #0f172a; font-size: 24px; font-weight: 700;">Booking Confirmed!</h2>
        <p style="margin: 8px 0 0 0; color: #64748b; font-size: 14px;">We're excited to see you, ${customerName}!</p>
      </div>
      
      <!-- Booking Details -->
      <div style="padding: 24px 0;">
        <h3 style="margin: 0 0 16px 0; color: #0f172a; font-size: 18px; font-weight: 600;">Booking Details</h3>
        
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td colspan="2" style="padding: 12px 16px; background: #f8fafc; border-radius: 8px 8px 0 0;">
              <p style="margin: 0; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Room</p>
              <p style="margin: 4px 0 0 0; color: #0f172a; font-size: 16px; font-weight: 600;">${roomName}</p>
            </td>
          </tr>
          <tr>
            <td colspan="2" style="padding: 12px 16px; background: #f8fafc;">
              <p style="margin: 0; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Date</p>
              <p style="margin: 4px 0 0 0; color: #0f172a; font-size: 16px; font-weight: 600;">${formatDate(date)}</p>
            </td>
          </tr>
          <tr>
            <td style="padding: 12px 16px; background: #f8fafc; border-radius: 0 0 0 8px;">
              <p style="margin: 0; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Time</p>
              <p style="margin: 4px 0 0 0; color: #0f172a; font-size: 16px; font-weight: 600;">${formatTime(startTime)} - ${formatTime(endTime)}</p>
            </td>
            <td style="padding: 12px 16px; background: #f8fafc; border-radius: 0 0 8px 0;">
              <p style="margin: 0; color: #64748b; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Duration</p>
              <p style="margin: 4px 0 0 0; color: #0f172a; font-size: 16px; font-weight: 600;">${hours} hour${hours > 1 ? 's' : ''}</p>
            </td>
          </tr>
        </table>
        
        <!-- Price -->
        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; text-align: center;">
          <p style="margin: 0; color: #78350f; font-size: 14px; font-weight: 600;">Total Amount</p>
          <p style="margin: 4px 0 0 0; color: #78350f; font-size: 32px; font-weight: 700;">$${price}</p>
          <p style="margin: 4px 0 0 0; color: #92400e; font-size: 12px;">Payment due at the venue</p>
        </div>
      </div>
      
      <!-- Location -->
      <div style="padding: 20px 0; border-top: 1px solid #f1f5f9;">
        <h3 style="margin: 0 0 12px 0; color: #0f172a; font-size: 16px; font-weight: 600;">üìç Location</h3>
        <p style="margin: 0; color: #475569; font-size: 14px; line-height: 1.6;">
          <strong>K one Golf</strong><br>
          45 Keltic Dr, Unit 6<br>
          Sydney, NS B1S 1P4<br>
          Phone: (902) 270-2259
        </p>
        <p style="margin: 12px 0 0 0;">
          <a href="https://maps.google.com/?q=45+Keltic+Dr+Unit+6+Sydney+NS" style="color: #f59e0b; text-decoration: none; font-weight: 600; font-size: 14px;">Get Directions ‚Üí</a>
        </p>
      </div>
      
      <!-- Calendar Attachment Info -->
      <div style="padding: 16px; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 4px; margin-top: 20px;">
        <p style="margin: 0; color: #1e40af; font-size: 14px;">
          <strong>üìÖ Add to Calendar</strong>
        </p>
        <p style="margin: 4px 0 0 0; color: #3b82f6; font-size: 13px;">
          A calendar file (.ics) is attached. Click it to add this booking to your calendar app.
        </p>
      </div>
      
      <!-- Manage Booking -->
      <div style="margin-top: 24px; text-align: center;">
        <a href="${process.env.FRONTEND_ORIGIN || 'http://localhost:5173'}/dashboard" style="display: inline-block; padding: 12px 32px; background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">View My Bookings</a>
      </div>
      
      <!-- Footer -->
      <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #f1f5f9; text-align: center;">
        <p style="margin: 0; color: #94a3b8; font-size: 12px;">
          Questions? Contact us at (902) 270-2259 or visit our website
        </p>
        <p style="margin: 8px 0 0 0; color: #94a3b8; font-size: 11px;">
          Hours: 10:00 AM - 12:00 AM Daily
        </p>
      </div>
    </div>
  </div>
</body>
</html>
  `;
}

/**
 * Send booking confirmation email with ICS calendar attachment
 */
export async function sendBookingConfirmation(params: BookingConfirmationParams) {
  const subject = `Booking Confirmed - K one Golf`;
  const html = generateBookingConfirmationHTML(params);
  const icsContent = generateICS(params);
  
  const tz = params.customerTimezone || 'America/Halifax';
  
  const formatTime = (d: Date) => d.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    hour12: true,
    timeZone: tz
  });
  
  const text = `
K one Golf - Booking Confirmation

Hi ${params.customerName},

Your booking has been confirmed!

Booking Details:
- Room: ${params.roomName}
- Date: ${params.date}
- Time: ${formatTime(params.startTime)} - ${formatTime(params.endTime)}
- Duration: ${params.hours} hour${params.hours > 1 ? 's' : ''}
- Total: $${params.price}

Location:
K one Golf
45 Keltic Dr, Unit 6
Sydney, NS B1S 1P4
Phone: (902) 270-2259

A calendar file is attached to help you add this booking to your calendar.

See you soon!

---
K one Golf - Premium Screen Golf
Hours: 10:00 AM - 12:00 AM Daily
  `.trim();

  const transport = getTransport();
  if (!transport) {
    log.info({ to: params.to }, 'Dev-log: booking confirmation (no transport)');
    return;
  }

  await transport.sendMail({
    from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>',
    to: params.to,
    subject,
    text,
    html,
    attachments: [
      {
        filename: 'booking.ics',
        content: icsContent,
        contentType: 'text/calendar; charset=utf-8; method=REQUEST'
      }
    ]
  });
}

/**
 * Send contact form email to konegolf.general@gmail.com
 */
export async function sendContactEmail({ firstName, lastName, email, message }: ContactEmailParams) {
  const to = 'konegolf.general@gmail.com';
  const subject = `Contact Form: ${firstName} ${lastName}`;
  
  const text = `
New Contact Form Submission

Name: ${firstName} ${lastName}
Email: ${email}

Message:
${message}
  `.trim();

  const html = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Form Submission</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f8fafc;">
  <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <!-- Header -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #eab308 100%); padding: 32px 24px; text-align: center; border-radius: 12px 12px 0 0;">
      <h1 style="margin: 0; color: white; font-size: 24px; font-weight: 700;">New Contact Form</h1>
    </div>
    
    <!-- Content -->
    <div style="background: white; padding: 32px 24px; border-radius: 0 0 12px 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
      <div style="margin-bottom: 20px;">
        <p style="margin: 0 0 8px 0; font-weight: 600; color: #334155;">Name:</p>
        <p style="margin: 0; color: #475569;">${firstName} ${lastName}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="margin: 0 0 8px 0; font-weight: 600; color: #334155;">Email:</p>
        <p style="margin: 0; color: #475569;"><a href="mailto:${email}" style="color: #2563eb;">${email}</a></p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <p style="margin: 0 0 8px 0; font-weight: 600; color: #334155;">Message:</p>
        <p style="margin: 0; color: #475569; white-space: pre-wrap;">${message}</p>
      </div>
    </div>
    
    <!-- Footer -->
    <div style="margin-top: 20px; text-align: center; color: #64748b; font-size: 12px;">
      <p>This message was sent from the K one Golf contact form.</p>
    </div>
  </div>
</body>
</html>
  `.trim();

  const transport = getTransport();
  if (!transport) {
    log.info({ from: email }, 'Dev-log: contact form (no transport)');
    return;
  }

  await transport.sendMail({
    from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>',
    to,
    subject,
    text,
    html,
    replyTo: email,
  });
}

// ‚îÄ‚îÄ‚îÄ Coupon Email ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export interface CouponEmailParams {
  to: string;
  customerName: string;
  couponCode: string;
  couponType: 'BIRTHDAY' | 'LOYALTY' | 'CUSTOM' | string;
  description: string;
  discountAmount: number;
  expiresAt?: Date | null;
}

function getCouponEmailContent(type: string): { emoji: string; heading: string; subtext: string } {
  switch (type) {
    case 'BIRTHDAY':
      return { emoji: 'üéÇ', heading: 'Happy Birthday!', subtext: 'We have a special gift for you to celebrate your birthday!' };
    case 'LOYALTY':
      return { emoji: '‚≠ê', heading: 'Thank You for Your Loyalty!', subtext: 'You\'ve reached a milestone and earned a reward!' };
    default:
      return { emoji: 'üéüÔ∏è', heading: 'You\'ve Received a Coupon!', subtext: 'Here\'s a special offer just for you!' };
  }
}

export async function sendCouponEmail(params: CouponEmailParams) {
  const { to, customerName, couponCode, couponType, description, discountAmount, expiresAt } = params;
  const origin = process.env.FRONTEND_ORIGIN || 'http://localhost:5173';
  const couponUrl = `${origin.replace(/\/$/, '')}/coupon/${couponCode}`;
  const { emoji, heading, subtext } = getCouponEmailContent(couponType);

  // Generate QR code as base64 PNG for inline embedding
  const qrDataUrl = await QRCode.toDataURL(couponUrl, {
    width: 200,
    margin: 2,
    color: { dark: '#1e293b', light: '#ffffff' },
  });
  // Convert data URL to buffer for cid attachment
  const qrBase64 = qrDataUrl.replace(/^data:image\/png;base64,/, '');
  const qrBuffer = Buffer.from(qrBase64, 'base64');

  const expiryLine = expiresAt
    ? `<p style="font-size:13px;color:#94a3b8;margin:12px 0 0;text-align:center">Expires: ${new Date(expiresAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/Halifax' })}</p>`
    : '';

  const subject = couponType === 'BIRTHDAY'
    ? `${emoji} Happy Birthday, ${customerName}! You've earned 1 hour free!`
    : couponType === 'LOYALTY'
      ? `${emoji} Thank you, ${customerName}! You've earned 1 hour free!`
      : `${emoji} ${customerName}, you've received a coupon from K one Golf!`;

  const text = `${heading}\n\nHi ${customerName},\n\n${subtext}\n\n${description}\nValue: $${discountAmount.toFixed(2)}\n\nYour coupon code: ${couponCode}\nView your coupon: ${couponUrl}\n\nShow this code or QR to staff to redeem.\n${expiresAt ? `Expires: ${new Date(expiresAt).toLocaleDateString()}\n` : ''}`;

  const html = `<!doctype html>
<html><body style="font-family:system-ui,sans-serif;background:#f8fafc;padding:20px;margin:0">
<div style="max-width:480px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1)">
  <div style="background:linear-gradient(135deg,#f59e0b 0%,#eab308 100%);padding:28px 24px;text-align:center">
    <h1 style="margin:0;color:#fff;font-size:24px;font-weight:700">K ONE GOLF</h1>
    <p style="margin:4px 0 0;color:rgba(255,255,255,0.9);font-size:14px">${emoji} ${heading}</p>
  </div>
  <div style="padding:32px 24px;text-align:center">
    <p style="color:#334155;font-size:16px;line-height:1.6;margin:0 0 8px">Hi <strong>${customerName}</strong>,</p>
    <p style="color:#64748b;font-size:15px;line-height:1.6;margin:0 0 24px">${subtext}</p>
    <div style="background:#fffbeb;border:2px dashed #f59e0b;border-radius:12px;padding:24px;margin:0 0 24px">
      <p style="margin:0 0 4px;font-size:13px;color:#92400e;text-transform:uppercase;letter-spacing:1px;font-weight:600">Your Coupon</p>
      <p style="margin:0 0 12px;font-size:28px;font-weight:800;color:#1e293b;letter-spacing:2px">${couponCode}</p>
      <p style="margin:0 0 4px;font-size:15px;color:#334155;font-weight:600">${description}</p>
      <p style="margin:0;font-size:14px;color:#64748b">Value: <strong>$${discountAmount.toFixed(2)}</strong></p>
    </div>
    <div style="margin:0 0 24px">
      <p style="font-size:13px;color:#64748b;margin:0 0 12px">Scan QR code to view your coupon:</p>
      <img src="cid:couponQR" alt="Coupon QR Code" width="180" height="180" style="border-radius:8px" />
    </div>
    <a href="${couponUrl}" style="display:inline-block;padding:12px 32px;background:#2563eb;color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:15px">View Coupon</a>
    ${expiryLine}
    <p style="font-size:13px;color:#94a3b8;margin:20px 0 0">Show this code or QR to staff at K one Golf to redeem.</p>
  </div>
</div>
</body></html>`;

  const transport = getTransport();
  if (!transport) {
    log.info({ to, couponCode }, 'Dev-log: coupon email (no transport)');
    return;
  }

  await transport.sendMail({
    from: process.env.EMAIL_FROM || 'K one Golf <no-reply@konegolf.ca>',
    to,
    subject,
    text,
    html,
    attachments: [{
      filename: 'coupon-qr.png',
      content: qrBuffer,
      cid: 'couponQR',
    }],
  });
}
