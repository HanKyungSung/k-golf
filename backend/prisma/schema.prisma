// K-Golf Booking Platform Prisma Schema (Phase 1.2)
// NOTE: Overlap constraint added via a raw SQL migration after initial migrate.

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
}

// Booking status moved to String for flexibility; enforce allowed values in app code

model User {
  id                 String              @id @default(uuid())
  email              String              @unique
  name               String
  phone              String
  emailVerifiedAt    DateTime? @db.Timestamptz // retained but unused in password-only flow (can drop later)
  passwordHash       String?
  passwordUpdatedAt  DateTime? @db.Timestamptz
  role               UserRole            @default(CUSTOMER)
  createdAt          DateTime            @default(now()) @db.Timestamptz
  updatedAt          DateTime            @updatedAt @db.Timestamptz
  bookings           Booking[]
  authProviders      AuthProvider[]
  sessions           Session[]
  emailVerificationToken EmailVerificationToken?
}

model Room {
  id        String    @id @default(uuid())
  name      String    @unique
  capacity  Int       @default(4)
  active    Boolean   @default(true) // legacy; prefer status
  openMinutes  Int    @default(540)   // 09:00 local
  closeMinutes Int    @default(1140)  // 19:00 local
  status    RoomStatus @default(ACTIVE)
  createdAt DateTime  @default(now()) @db.Timestamptz
  updatedAt DateTime  @updatedAt @db.Timestamptz
  bookings  Booking[]
}

enum RoomStatus {
  ACTIVE
  MAINTENANCE
  CLOSED
}

model Booking {
  id            String        @id @default(uuid())
  room          Room          @relation(fields: [roomId], references: [id])
  roomId        String
  user          User          @relation(fields: [userId], references: [id])
  userId        String
  customerName  String        // Denormalized for display
  customerPhone String        // Denormalized for contact
  startTime     DateTime @db.Timestamptz
  endTime       DateTime @db.Timestamptz
  players       Int
  price         Decimal       @db.Decimal(10, 2)
  status        String        @default("CONFIRMED")
  createdAt     DateTime      @default(now()) @db.Timestamptz
  updatedAt     DateTime      @updatedAt @db.Timestamptz

  @@index([roomId, startTime])
  @@index([userId, startTime])
}

model AuthProvider {
  id             String   @id @default(uuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String
  provider       String
  providerUserId String?
  createdAt      DateTime @default(now()) @db.Timestamptz

  @@unique([provider, providerUserId])
}


model Session {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  sessionToken String   @unique
  expiresAt    DateTime @db.Timestamptz
  createdAt    DateTime @default(now()) @db.Timestamptz
  updatedAt    DateTime @updatedAt @db.Timestamptz
}

// Stores single active email verification token per user
model EmailVerificationToken {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String   @unique
  tokenHash  String   @unique
  expiresAt  DateTime @db.Timestamptz
  consumedAt DateTime? @db.Timestamptz
  createdAt  DateTime @default(now()) @db.Timestamptz

  @@index([expiresAt])
}
